<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing your first DeepPLP model • DeepPatientLevelPrediction</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developing your first DeepPLP model">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DeepPatientLevelPrediction</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.1.0.9999</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/Installing.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/FirstModel.html">My first deep learning model</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BuildingDeepModels.html">Building Deep Learning Models</a></li>
    <li><a class="dropdown-item" href="../articles/FirstModel.html">Developing your first DeepPLP model</a></li>
    <li><a class="dropdown-item" href="../articles/Installing.html">DeepPatientLevelPrediction Installation Guide</a></li>
    <li><a class="dropdown-item" href="../articles/TransferLearning.html">How to use DeepPatientLevelPrediction for Transfer Learning</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/DeepPatientLevelPrediction"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Developing your first DeepPLP model</h1>
                        <h4 data-toc-skip class="author">Egill
Fridgeirsson</h4>
            
            <h4 data-toc-skip class="date">2024-10-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/DeepPatientLevelPrediction/blob/develop/vignettes/FirstModel.Rmd" class="external-link"><code>vignettes/FirstModel.Rmd</code></a></small>
      <div class="d-none name"><code>FirstModel.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Developing your first DeepPLP model}
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes how you can develop your first deep learning
model using the deepPLP package on OMOP-CDM data.</p>
<p>First make sure you have everything installed correctly by following
the <a href="https://ohdsi.github.io/DeepPatientLevelPrediction/articles/Installing.html" class="external-link">installation
guide</a></p>
</div>
<div class="section level2">
<h2 id="the-data">The data<a class="anchor" aria-label="anchor" href="#the-data"></a>
</h2>
<p>Since there is no publicly available data we use a nifty little
package called <a href="https://github.com/OHDSI/Eunomia" class="external-link">Eunomia</a>
which provides us with synthetic data in the OMOP-CDM.</p>
<p>It can be installed with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'Eunomia'</span><span class="op">)</span></span></code></pre></div>
<p>To start with we have to define our cohorts of interest and extract a
so called plpData object with the features we want to use.</p>
<p>In Eunomia the cohorts have already been defined but we need to
create them. This we can do by running:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/createCohorts.html" class="external-link">createCohorts</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span></code></pre></div>
<p>The first line gets the Eunomia connection details. The Eunomia data
is stored in a sqlite database. The second line creates the cohorts. You
should see output confirming that three target cohorts have been
created, consisting of users of certain medications and one outcome
cohort of gastrointestinal bleeding.</p>
</div>
<div class="section level2">
<h2 id="our-settings">Our settings<a class="anchor" aria-label="anchor" href="#our-settings"></a>
</h2>
<p>We define our covariate settings using <a href="https://github.com/OHDSI/FeatureExtraction" class="external-link">FeatureExtraction</a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covariateSettings</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html" class="external-link">createCovariateSettings</a></span><span class="op">(</span></span>
<span>  useDemographicsGender <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  useDemographicsAge <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  useConditionOccurrenceLongTerm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This means we are extracting gender as a binary variable, age as a
continuous variable and conditions occurring in the long term window,
which is by default 365 days prior to index. If you want to know more
about these terms we recommend checking out the <a href="https://ohdsi.github.io/TheBookOfOhdsi/" class="external-link">book of OHDSI</a>.</p>
<p>Next we need to define our database details, which defines from which
database we are getting which cohorts. Since we don’t have a database we
are using Eunomia.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">databaseDetails</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createDatabaseDetails.html" class="external-link">createDatabaseDetails</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>, </span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cdmDatabaseId <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, </span>
<span>  cohortTable <span class="op">=</span> <span class="st">"cohort"</span>, </span>
<span>  targetId<span class="op">=</span> <span class="fl">4</span>, </span>
<span>  outcomeIds <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>, </span>
<span>  outcomeTable <span class="op">=</span>  <span class="st">"cohort"</span>, </span>
<span>  cdmDatabaseName <span class="op">=</span> <span class="st">'eunomia'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This means we are using cohort 4 as our target cohort, the population
at risk, and 3 as the outcome cohort, those who experience the outcome.
According to the previous Eunomia output we are predicting
gastrointestinal bleeding in users of NSAIDs.</p>
<p>Now we define our study population and get the plpData object from
the database.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">populationSettings</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createStudyPopulationSettings.html" class="external-link">createStudyPopulationSettings</a></span><span class="op">(</span></span>
<span>                                                          requireTimeAtRisk <span class="op">=</span> <span class="cn">F</span>, </span>
<span>                                                          riskWindowStart <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                                          riskWindowEnd <span class="op">=</span> <span class="fl">365</span><span class="op">)</span></span>
<span><span class="va">plpData</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/getPlpData.html" class="external-link">getPlpData</a></span><span class="op">(</span></span>
<span>  databaseDetails <span class="op">=</span> <span class="va">databaseDetails</span>,</span>
<span>  covariateSettings <span class="op">=</span> <span class="va">covariateSettings</span>,</span>
<span>  restrictPlpDataSettings <span class="op">=</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/createRestrictPlpDataSettings.html" class="external-link">createRestrictPlpDataSettings</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When defining our study population we define the time-at-risk. Which
is when we are predicing if a certain patient gets the outcome or not.
Here we predict the outcome from the day after the patient starts using
NSAIDs until one year later.</p>
</div>
<div class="section level2">
<h2 id="the-model">The model<a class="anchor" aria-label="anchor" href="#the-model"></a>
</h2>
<p>Now it’s time to define our deep learning model. It can be daunting
for those not familiar with deep learning to define their first model
since the models are very flexible and have many hyperparameters to
define for your model architecture. To help with this
<code>deepPLP</code> has helper functions with a sensible set of
hyperparameters for testing. Best practice is though to do an extensive
hyperparameter tuning step using cross validation.</p>
<p>We will use a simple ResNet for our example. ResNet are simple models
that have skip connections between layers that allow for deeper models
without overfitting. The default ResNet is a 6 layer model with 512
neurons per layer.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OHDSI/DeepPatientLevelPrediction" class="external-link">DeepPatientLevelPrediction</a></span><span class="op">)</span></span>
<span><span class="va">modelSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setDefaultResNet.html">setDefaultResNet</a></span><span class="op">(</span></span>
<span>  estimatorSettings <span class="op">=</span> <span class="fu"><a href="../reference/setEstimator.html">setEstimator</a></span><span class="op">(</span>learningRate<span class="op">=</span><span class="fl">3e-4</span>,</span>
<span>                                   device<span class="op">=</span><span class="st">"cpu"</span>,</span>
<span>                                   batchSize<span class="op">=</span><span class="fl">256L</span>,</span>
<span>                                   epochs<span class="op">=</span><span class="fl">3L</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We still need to define a few parameters. Device defines on which
device to train the model. Usually deep learning models are slow to
train so they need a GPU. However this example is small enough that we
can use a CPU. If you have access to a GPU you can try changing the
device to <code>'cuda'</code> and see how much faster it goes.</p>
<p>We also need to define our batch size. Usually in deep learning the
model sees only a small chunk of the data at a time, in this case 256
patients. After that the model is updated before seeing the next batch.
The batch order is random. This is called stochastic gradient
descent.</p>
<p>Finally we define our epochs. This is how long we will train the
model. One epoch means the model has seen all the data once. In this
case we will train the model for 3 epochs.</p>
<p>Now all that is left is using the PLP to train our first deep
learning model. If you have used the PLP this should look familiar to
you.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plpResults</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/PatientLevelPrediction/reference/runPlp.html" class="external-link">runPlp</a></span><span class="op">(</span>plpData <span class="op">=</span> <span class="va">plpData</span>,</span>
<span>               outcomeId <span class="op">=</span> <span class="fl">3</span>,</span>
<span>               modelSettings <span class="op">=</span> <span class="va">modelSettings</span>,</span>
<span>               analysisId <span class="op">=</span> <span class="st">'ResNet'</span>,</span>
<span>               analysisName <span class="op">=</span> <span class="st">'Testing DeepPlp'</span>,</span>
<span>               populationSettings <span class="op">=</span> <span class="va">populationSettings</span></span>
<span>                                                      <span class="op">)</span></span></code></pre></div>
<p>On my computer this takes about 20 seconds per epoch. While you
probably won’t see any kind of good performance using this model and
this data, at least the training loss should be decreasing in the
printed output.</p>
<p>Congratulations you have just developed your first deep learning
model!</p>
</div>
<div class="section level2">
<h2 id="acknowledgments">Acknowledgments<a class="anchor" aria-label="anchor" href="#acknowledgments"></a>
</h2>
<p>Considerable work has been dedicated to provide the
<code>DeepPatientLevelPrediction</code> package.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span><span class="st">"DeepPatientLevelPrediction"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## To cite package 'DeepPatientLevelPrediction' in publications use:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   Fridgeirsson E, Reps J, Chan You S, Kim C, John H (8).</span></span>
<span><span class="co">##   _DeepPatientLevelPrediction: Deep Learning For Patient Level</span></span>
<span><span class="co">##   Prediction Using Data In The OMOP Common Data Model_. R package</span></span>
<span><span class="co">##   version 2.1.0.9999,</span></span>
<span><span class="co">##   &lt;https://github.com/OHDSI/DeepPatientLevelPrediction&gt;.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   @Manual{,</span></span>
<span><span class="co">##     title = {DeepPatientLevelPrediction: Deep Learning For Patient Level Prediction Using Data In The</span></span>
<span><span class="co">## OMOP Common Data Model},</span></span>
<span><span class="co">##     author = {Egill Fridgeirsson and Jenna Reps and Seng {Chan You} and Chungsoo Kim and Henrik John},</span></span>
<span><span class="co">##     year = {8},</span></span>
<span><span class="co">##     note = {R package version 2.1.0.9999},</span></span>
<span><span class="co">##     url = {https://github.com/OHDSI/DeepPatientLevelPrediction},</span></span>
<span><span class="co">##   }</span></span></code></pre>
<p><strong>Please reference this paper if you use the PLP Package in
your work:</strong></p>
<p><a href="http://dx.doi.org/10.1093/jamia/ocy032" class="external-link">Reps JM, Schuemie
MJ, Suchard MA, Ryan PB, Rijnbeek PR. Design and implementation of a
standardized framework to generate and evaluate patient-level prediction
models using observational healthcare data. J Am Med Inform Assoc.
2018;25(8):969-975.</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Egill Fridgeirsson, Jenna Reps, Seng Chan You, Chungsoo Kim, Henrik John.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
